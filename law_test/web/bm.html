<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Home</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">
		<meta name="keywords" content="" />
		<link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/mdui/0.4.2/css/mdui.min.css">
		<script src="//cdnjs.loli.net/ajax/libs/mdui/0.4.2/js/mdui.min.js"></script>
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/index_beta.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/connectToBroker.js"></script>
	</head>
	<body onload="show(0);order();" class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-pink ">
	<div id="inc_appbar"></div>

	<div id="inc_menu"></div>

	<div id="inc_notification"></div>
<div class="mdui-container">
		<ul class="mdui-menu mdui-menu-cascade" id="sort_menu">
			<li class="mdui-menu-item">
				<a class="mdui-ripple">
					首要关键字
					<span class="mdui-menu-item-more"></span>
				</a>
				<ul class="mdui-menu">
					<li class="mdui-menu-item ">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="OrderId" checked/><i class="mdui-radio-icon"></i>订单号</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="UserId"/><i class="mdui-radio-icon"></i>用户ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="UserName"/><i class="mdui-radio-icon"></i>用户名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="StockId"/><i class="mdui-radio-icon"></i>股票ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="StockName"/><i class="mdui-radio-icon"></i>股票名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="Quantity"/><i class="mdui-radio-icon"></i>持有数量</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="BUnitPrice"/><i class="mdui-radio-icon"></i>订单价格</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="CreateAt"/><i class="mdui-radio-icon"></i>创建时间</label>
					</li>
				</ul>
			</li>
			<li class="mdui-menu-item">
				<a class="mdui-ripple">
					次要关键字
					<span class="mdui-menu-item-more"></span>
				</a>
				<ul class="mdui-menu">
					<li class="mdui-menu-item ">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="OrderId" checked/><i class="mdui-radio-icon"></i>订单号</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="UserId"/><i class="mdui-radio-icon"></i>用户ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="UserName"/><i class="mdui-radio-icon"></i>用户名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="StockId"/><i class="mdui-radio-icon"></i>股票ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="StockName"/><i class="mdui-radio-icon"></i>股票名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="Quantity"/><i class="mdui-radio-icon"></i>持有数量</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="BUnitPrice"/><i class="mdui-radio-icon"></i>订单价格</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="CreateAt"/><i class="mdui-radio-icon"></i>创建时间</label>
					</li>
				</ul>
			</li>
		</ul>


			<button class="mdui-btn" mdui-menu="{target:'#sort_menu'}">排序</button>
			<button class="mdui-btn" mdui-dialog="{'target':'#search_dialog'}">查找</button>
			<button type="button" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="window.location='bm_print.html'">打印</button>
			<a href = "bmdataToCSV" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent">导出</a>
			<button type="button"class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="home()">仓库主页</button>
			<div class="mdui-dialog" id="search_dialog">
				<div class="mdui-dialog-title">查找订单</div>
				<form name="user_search_form" class="mdui-dialog-content">
					<div class="mdui-textfield">

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">订单号</label>
							<input class="mdui-textfield-input" id="OrderId" name="OrderId" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">用户ID</label>
							<input class="mdui-textfield-input" id="UserId" name="UserId" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">用户名称</label>
							<input class="mdui-textfield-input" id="UserName" name="UserName" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">股票ID</label>
							<input class="mdui-textfield-input" id="StockId" name="StockId" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">股票名称</label>
							<input class="mdui-textfield-input" id="StockName" name="StockName" type="text" value=""/>
						</div>

					</div>
				</form>
				<div class="mdui-dialog-actions">
					<button class="mdui-btn" onclick="query()" mdui-dialog-confirm>
						搜索
					</button>
				</div>
			</div>

	<div class="mdui-dialog" id="modify">
		<div class="mdui-dialog-content">
			<div class="mdui-dialog-title">确认订单</div>
			请将您确定订单内容
			<div class="mdui-textfield">
				<input class="mdui-textfield-input" type="text" disabled placeholder="order_id" id="order_id"/>
			</div>

			<div class="mdui-textfield">
				<label class="mdui-textfield-label">用户ID</label>
				<input class="mdui-textfield-input" id="user_id" disabled placeholder="user_id"/>
			</div>

			<div class="mdui-textfield">
				<label class="mdui-textfield-label">用户名称</label>
				<input class="mdui-textfield-input" id="user_name" disabled placeholder="user_name"/>
			</div>

			<div class="mdui-textfield">
				<label class="mdui-textfield-label">股票ID</label>
				<input class="mdui-textfield-input" id="stock_id" disabled placeholder="stock_id"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">股票名称</label>
				<input class="mdui-textfield-input" id="stock_name" disabled placeholder="stock_name"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">持有数量</label>
				<input class="mdui-textfield-input" id="quantity" disabled placeholder="quantity"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">订单价格</label>
				<input class="mdui-textfield-input" id="bunitprice" disabled placeholder="bunitprice"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">交易时间</label>
				<input class="mdui-textfield-input" type="datetime" id="createat" disabled placeholder="createat"/>
			</div>
		</div>
		<div class="mdui-dialog-actions">
			<button class="mdui-btn mdui-ripple" mdui-dialog-close onclick="modify()">确定</button>
		</div>
	</div>

		<div>
			<div class="mdui-table-fluid">
				<table class="mdui-table mdui-table-hoverable" id="bus_table">
					<tr>
						<th>订单号</th>
						<th>用户ID</th>
						<th>用户名称</th>
						<th>股票ID</th>
						<th>股票名称</th>
						<th>持有数量</th>
						<th>订单价格</th>
						<th>交易日期</th>
						<th>操作</th>
					</tr>
					<tbody id="bus_list">

					</tbody>
				</table>
				<button class="mdui-btn" onclick="show(0)" style="width: 100%">加载更多</button>
			</div>

			<div class="mdui-typo">
				<h1>交易记录新增统计</h1>
				<div class="mdui-img-fluid" id="chartdiv">

				</div>
			</div>
		</div>
</div>
	</body>
</html>

<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/material.js"></script>
<script src="https://www.amcharts.com/lib/4/lang/de_DE.js"></script>
<script src="https://www.amcharts.com/lib/4/geodata/germanyLow.js"></script>

<script>
	$('#inc_appbar').load("index_beta.html #appbar");
	$('#inc_menu').load("index_beta.html #left-drawer",function(responseTxt,statusTxt,xhr){
		initPage();
		connect();
		$('#title').text("买入区");
	});
	$('#inc_notification').load("index_beta.html #notifications");
	var List;
	var limit=15;
	var bus_info;
	var len=0;
	var Order=0;
	var orderid="";
	var userid="";
	var username="";
	var stockid="";
	var stockname="";
	var create="";

	function modify_record(i){
		var inst = new mdui.Dialog("#modify");
		inst.open();
		document.getElementById("order_id").value = List[i].orderid;
		document.getElementById("user_id").value = List[i].userid;
		document.getElementById("user_name").value = List[i].username;
		document.getElementById("stock_id").value = List[i].stockid;
		document.getElementById("stock_name").value = List[i].stockname;
		document.getElementById("quantity").value = List[i].quantity;
		document.getElementById("bunitprice").value = List[i].bunitprice;
		document.getElementById("createat").value = List[i].createat;

	}

	function modify(){
		url = "bmchangeAction";
		url = getQueryPath(url)
		var order_id=document.getElementById("order_id").value;
		var user_id=document.getElementById("user_id").value;
		var user_name=document.getElementById("user_name").value;
		var stock_id=document.getElementById("stock_id").value;
		var stock_name=document.getElementById("stock_name").value;
		var quan_tity=document.getElementById("quantity").value;
		var bunit_price=document.getElementById("bunitprice").value;
		var create_at=document.getElementById("createat").value;
		var data = '{"OrderId":"'+order_id+'","UserId":"'+user_id+'","UserName":"'+user_name+'","StockId":"'+stock_id+'","StockName":"'+stock_name+'","Quantity":"'+quan_tity+'","BUnitPrice":"'+bunit_price+'","CreateAt":"'+create_at+'"}';
		console.log(data);
		var obj = JSON.parse(data);
		$.post(url,obj,function(json){
			console.log("dao zhe li le!!!");
			if(json.status=="1"){
				limit = limit -15;
				mdui.snackbar({'message':'买入成功！'});
				show(1);
			}
			else if(json.status=="error")
			{
				if(json.code==2)
				{
					mdui.snackbar({'message':'不能购买自己发布的订单！'});
					show(1);
				}
				else
				{
					if(json.code==3)
					{
						mdui.snackbar({'message':'买入失败！您的余额不足，请及时冲值！'});
						show(1);
					}
					else
					{
						if(json.code==4)
						{
							mdui.snackbar({'message':'发生严重错误，数据库期货数量出现问题！'});
							show(1);
						}
						else
						{
							if(json.code==5)
							{
								mdui.snackbar({'message':'已经没有此订单了！'});
								show(1);
							}
							else
							{
								console.log("7777777777");
								mdui.snackbar({'message':'买入失败！'});
								show(1);
							}

						}
					}
				}
			}
		})
	}

	function home(){
		window.location="bm.html";
	}

	function delet(id){
		mdui.confirm("您确认要删除这个用户吗?<br>注意：删除操作是不可逆的，请仔细考虑!","删除确认",function(){
			var url = "bmdeleteAction?OrderId="+id;
			url=getQueryPath(url);
			var data1 = '{"OrderId":"'+id+'"}';

			var obj = JSON.parse(data1);

			$.post(url,obj,function(json){
				console.log(JSON.stringify(json));
				if(json.status==1){
					limit = limit - 15;
					mdui.snackbar({'message':'删除成功!'});
					show(1);
				}
				else{
					mdui.snackbar({'message':'删除失败!'});
				}

			})
		},function(){
			;
		});

	}

	function exported(){
		var url = "bmdataToCSV";
		url=getQueryPath(url);
		$.post(url,function(json){
			console.log(JSON.stringify(json));
		})
	}

	function query(){
		var url = "bmquerylistAction";
		url=getQueryPath(url);
		console.log("22222222222222");
		orderid = document.getElementById("OrderId").value;
		userid = document.getElementById("UserId").value;
		username = document.getElementById("UserName").value;
		stockid = document.getElementById("StockId").value;
		stockname = document.getElementById("StockName").value;
		var sel1 = $("input[type=radio][name=group1]:checked").val();
		var sel2 = $("input[type=radio][name=group2]:checked").val();
		var parent = document.getElementById("bus_list");
		parent.innerHTML = "";
		limit = limit-15;
		show(1);
	}
	function clearBusTable()
	{
		var table=document.getElementById("bus_table");
		var rowCount=table.rows.length;
		for(var i=rowCount-1;i>0;i--){
			table.deleteRow(i);
		}
		mdui.updateTables("#bus_table");
	}


	function updateTable(json){

		List=json.list;
		limit = limit + 15;
		len = List.length;
		var table = document.getElementById('bus_list');
		table.innerHTML="";
		for(var i = 0; i < List.length; i++){
			var newNode = document.createElement("tr");
			var id = List[i].orderid;
			newNode.innerHTML = "<td>"+List[i].orderid+"</td>"
			newNode.innerHTML += "<td>"+List[i].userid +"</td><td>"+List[i].username +"</td><td>"+List[i].stockid +"</td><td>"+List[i].stockname +"</td><td>"+List[i].quantity +"</td><td>"+List[i].bunitprice +"</td><td>" +List[i].createat + "</td>";
			newNode.innerHTML += "<td><button class=\"mdui-btn mdui-btn-raised\" onclick='modify_record("+i+")'>买入</button></td>"
			table.appendChild(newNode);
		}
	}


	function order(){
		$("input[type=radio]").change(function(){
			var parent = document.getElementById("bus_list");
			parent.innerHTML = "";
			limit = limit-15;

			show(1);
		});
	}
	function show(Order){

		var url = "bmquerylistAction";
		url=getQueryPath(url);
		sel1 = $("input[type=radio][name=group1]:checked").val();
		sel2 = $("input[type=radio][name=group2]:checked").val();
		var data1 = '{"Sel1":"'+sel1+'","Sel2":"'+sel2+'","limit":"'+limit+'","length":"'+len+'","OrderId":"'+orderid+'","UserId":"'+userid+'","UserName":"'+username+'","StockId":"'+stockid+'","StockName":"'+stockname+'"}';

		var j = JSON.parse(data1);
		$.post(url,j,function(json){
			//console.log(JSON.stringify(json));
			bus_info=json.list;
			List=json.list;
			if(json.status == "error"){
				mdui.alert("出错了！");
			}
			else{
				if(json.end == 1 && Order == 0)
					mdui.snackbar("已经到达最后了!");
				else{
					updateTable(json);
				}
			}
		})
		statistics();
	}



	function  drawChart(json){
		console.log('开始绘图');
		var chart=am4core.create("chartdiv",am4charts.XYChart);
		chart.dateFormatter.inputDateFormat="yyyy-MM-dd";
		chart.data=json.data;
		var dateAxis=chart.xAxes.push(new am4charts.DateAxis());
		var valueAxix=chart.yAxes.push(new am4charts.ValueAxis());
		var lineSeries=chart.series.push(new am4charts.LineSeries());
		lineSeries.tooltipText = "{value}"
		lineSeries.dataFields.valueY="value";
		lineSeries.dataFields.dateX="date";
		lineSeries.tooltip.background.cornerRadius = 20;
		lineSeries.tooltip.background.strokeOpacity = 0;
		lineSeries.tooltip.pointerOrientation = "vertical";
		lineSeries.tooltip.label.minWidth = 40;
		lineSeries.tooltip.label.minHeight = 40;
		lineSeries.tooltip.label.textAlign = "middle";
		lineSeries.tooltip.label.textValign = "middle";

		var bullet = lineSeries.bullets.push(new am4charts.CircleBullet());
		bullet.circle.strokeWidth = 2;
		bullet.circle.radius = 4;
		bullet.circle.fill = am4core.color("#fff");
		var bullethover = bullet.states.create("hover");
		bullethover.properties.scale = 1.3;
		chart.cursor = new am4charts.XYCursor();
		chart.cursor.behavior = "panXY";
		chart.cursor.xAxis = dateAxis;
		chart.cursor.snapToSeries = lineSeries;
		lineSeries.name="Sales";
	}

	function statistics(){
		var url = "bmstatisticAction";
		url=getQueryPath(url);
		$.post(url,function(json){
			console.log(JSON.stringify(json));
			drawChart(json);
		})
	}

</script>