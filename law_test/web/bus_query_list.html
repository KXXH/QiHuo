<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Home</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">
		<meta name="keywords" content="" />
		<link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/mdui/0.4.2/css/mdui.min.css">
		<script src="//cdnjs.loli.net/ajax/libs/mdui/0.4.2/js/mdui.min.js"></script>
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/index_beta.js"></script>
		<script src="js/utils.js"></script>

	</head>
	<body onload="initPage();show(0);order();" class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-pink ">
		<div class="mdui-appbar mdui-appbar-fixed">
		<div class="mdui-toolbar mdui-color-theme">
			<a class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#left-drawer'}"><i class="mdui-icon material-icons">menu</i></a>
			<a href="javascript:;" class="mdui-typo-headline">期货交易系统</a>
			<a href="javascript:;" class="mdui-typo-title">交易管理</a>
			<div class="mdui-toolbar-spacer"></div>
			<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>
			<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">refresh</i></a>
			<a onclick="logOut();" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">exit_to_app</i></a>
		</div>
	</div>

	<div class="mdui-drawer mdui-shadow-5" id="left-drawer">
		<div class="mdui-spinner mdui-spinner-colorful" id="loader" style="display: block;margin-left:auto;margin-right:auto;margin-top: 50%"></div>
		<div class="mdui-list mdui-collapse" mdui-collapse="{accordion:true}" id="drawer"></div>
		</div>

<div class="mdui-container">
		<ul class="mdui-menu mdui-menu-cascade" id="sort_menu">
			<li class="mdui-menu-item">
				<a class="mdui-ripple">
					首要关键字
					<span class="mdui-menu-item-more"></span>
				</a>
				<ul class="mdui-menu">
					<li class="mdui-menu-item ">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="OrderId" checked/><i class="mdui-radio-icon"></i>订单号</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="UserId"/><i class="mdui-radio-icon"></i>用户ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="UserName"/><i class="mdui-radio-icon"></i>用户名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="StockId"/><i class="mdui-radio-icon"></i>股票ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="StockName"/><i class="mdui-radio-icon"></i>股票名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="Quantity"/><i class="mdui-radio-icon"></i>持有数量</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="BUnitPrice"/><i class="mdui-radio-icon"></i>订单价格</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group1" value="CreateAt"/><i class="mdui-radio-icon"></i>创建时间</label>
					</li>
				</ul>
			</li>
			<li class="mdui-menu-item">
				<a class="mdui-ripple">
					次要关键字
					<span class="mdui-menu-item-more"></span>
				</a>
				<ul class="mdui-menu">
					<li class="mdui-menu-item ">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="OrderId" checked/><i class="mdui-radio-icon"></i>订单号</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="UserId"/><i class="mdui-radio-icon"></i>用户ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="UserName"/><i class="mdui-radio-icon"></i>用户名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="StockId"/><i class="mdui-radio-icon"></i>股票ID</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="StockName"/><i class="mdui-radio-icon"></i>股票名称</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="Quantity"/><i class="mdui-radio-icon"></i>持有数量</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="BUnitPrice"/><i class="mdui-radio-icon"></i>订单价格</label>
					</li>
					<li class="mdui-menu-item">
						<label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="group2" value="CreateAt"/><i class="mdui-radio-icon"></i>创建时间</label>
					</li>
				</ul>
			</li>
		</ul>


			<button class="mdui-btn" mdui-menu="{target:'#sort_menu'}">排序</button>
			<button class="mdui-btn" mdui-dialog="{'target':'#search_dialog'}">查找</button>
			<button type="button" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="window.location='bus_print.html'">打印</button>

	<a class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" id="export_dialog">导出</a>


			<button type="button"class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="home()">交易管理主页</button>
			<div class="mdui-dialog" id="search_dialog">
				<div class="mdui-dialog-title">查找订单</div>
				<form name="user_search_form" class="mdui-dialog-content">
					<div class="mdui-textfield">

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">订单号</label>
							<input class="mdui-textfield-input" id="OrderId" name="OrderId" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">用户ID</label>
							<input class="mdui-textfield-input" id="UserId" name="UserId" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">用户名称</label>
							<input class="mdui-textfield-input" id="UserName" name="UserName" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">股票ID</label>
							<input class="mdui-textfield-input" id="StockId" name="StockId" type="text" value=""/>
						</div>

						<div class="mdui-textfield mdui-textfield-floating-label">
							<label class="mdui-textfield-label">股票名称</label>
							<input class="mdui-textfield-input" id="StockName" name="StockName" type="text" value=""/>
						</div>

					</div>
				</form>
				<div class="mdui-dialog-actions">
					<button class="mdui-btn" onclick="query()" mdui-dialog-confirm>
						搜索
					</button>
				</div>
			</div>

	<div class="mdui-dialog" id="modify">
		<div class="mdui-dialog-content">
			<div class="mdui-dialog-title">修改交易记录</div>
			请将您要修改的内容填入
			<div class="mdui-textfield">
				<input class="mdui-textfield-input" type="text" disabled placeholder="order_id" id="order_id"/>
			</div>

			<div class="mdui-textfield">
				<label class="mdui-textfield-label">用户ID</label>
				<input class="mdui-textfield-input" id="user_id" oninput="value=value.replace(/[^\d]/g,'')" maxlength="3"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">用户名称</label>
				<input class="mdui-textfield-input" id="user_name"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">股票ID</label>
				<input class="mdui-textfield-input" id="stock_id" oninput="value=value.replace(/[^\d]/g,'')" maxlength="3"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">股票名称</label>
				<input class="mdui-textfield-input" id="stock_name"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">持有数量</label>
				<input class="mdui-textfield-input" id="quantity" oninput="value=value.replace(/[^\d]/g,'')" maxlength="5"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">订单价格</label>
				<input class="mdui-textfield-input" id="bunitprice" oninput="value=value.replace(/[^\d]/g,'')" maxlength="6"/>
			</div>
			<div class="mdui-textfield">
				<label class="mdui-textfield-label">交易时间</label>
				<input class="mdui-textfield-input" type="datetime" id="createat"/>
			</div>
		</div>
		<div class="mdui-dialog-actions">
			<button class="mdui-btn mdui-ripple" onclick="modify()">确定</button>
		</div>
	</div>

		<div>
			<div class="mdui-table-fluid">
				<table class="mdui-table mdui-table-hoverable" id="bus_table">
					<tr>
						<th>订单号</th>
						<th>用户ID</th>
						<th>用户名称</th>
						<th>股票ID</th>
						<th>股票名称</th>
						<th>持有数量</th>
						<th>订单价格</th>
						<th>交易日期</th>
						<th>操作</th>
					</tr>
					<tbody id="bus_list">

					</tbody>
				</table>
				<button class="mdui-btn" onclick="show(0)" style="width: 100%">加载更多</button>
			</div>

			<div class="mdui-typo">
				<h1>交易记录新增统计</h1>
				<div class="mdui-img-fluid" id="chartdiv">

				</div>
			</div>
		</div>
</div>
	</body>
</html>

<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/material.js"></script>
<script src="https://www.amcharts.com/lib/4/lang/de_DE.js"></script>
<script src="https://www.amcharts.com/lib/4/geodata/germanyLow.js"></script>

<script>
	var list;
	var limit=15;
	var len=0;
	var Order=0;
	var orderid="";
	var userid="";
	var username="";
	var stockid="";
	var stockname="";
	var create="";

	function modify_record(i){
		var inst = new mdui.Dialog("#modify");
		inst.open();
		document.getElementById("order_id").value = list[i].orderid;
		document.getElementById("user_id").value = list[i].userid;
		document.getElementById("user_name").value = list[i].username;
		document.getElementById("stock_id").value = list[i].stockid;
		document.getElementById("stock_name").value = list[i].stockname;
		document.getElementById("quantity").value = list[i].quantity;
		document.getElementById("bunitprice").value = list[i].bunitprice;
		document.getElementById("createat").value = list[i].createat;

	}

	function modify(){
		url = "buschangeAction";
		url = getQueryPath(url)
		orderid=document.getElementById("order_id").value;
		userid=document.getElementById("user_id").value;
		username=document.getElementById("user_name").value;
		stockid=document.getElementById("stock_id").value;
		stockname=document.getElementById("stock_name").value;
		quantity=document.getElementById("quantity").value;
		bunitprice=document.getElementById("bunitprice").value;
		createat=document.getElementById("createat").value;
		var data = '{"OrderId":"'+orderid+'","UserId":"'+userid+'","UserName":"'+username+'","StockId":"'+stockid+'","StockName":"'+stockname+'","Quantity":"'+quantity+'","BUnitPrice":"'+bunitprice+'","CreateAt":"'+createat+'"}';
		var obj = JSON.parse(data);
		$.post(url,obj,function(json){
			if(json.status=="1"){
				limit = limit -15;
				mdui.snackbar({'message':'修改成功！'});
				show(1);
			}

			else
				mdui.snackbar({'message':'修改失败！'});
			show(1);
		})
	}

	function home(){
		window.location="bus_query_list.html";
	}
	function delet(id){
		mdui.confirm("您确认要删除这个用户吗?<br>注意：删除操作是不可逆的，请仔细考虑!","删除确认",function(){
			var url = "busdeleteAction?OrderId="+id;
			url=getQueryPath(url);
			var data1 = '{"OrderId":"'+id+'"}';

			var obj = JSON.parse(data1);

			$.post(url,obj,function(json){
				console.log(JSON.stringify(json));
				if(json.status==1){
					limit = limit - 15;
					mdui.snackbar({'message':'删除成功!'});
					show(1);
				}
				else{
					mdui.snackbar({'message':'删除失败!'});
				}

			})
		},function(){
			;
		});

	}

	function exported(){
		var url = "busdataToCSV";
		url=getQueryPath(url);
		$.post(url,function(json){
			console.log(JSON.stringify(json));
		})
	}

	function query(){
		var url = "busquerylistAction";
		url=getQueryPath(url);
		console.log("22222222222222");
		orderid = document.getElementById("OrderId").value;
		userid = document.getElementById("UserId").value;
		username = document.getElementById("UserName").value;
		stockid = document.getElementById("StockId").value;
		stockname = document.getElementById("StockName").value;
		var sel1 = $("input[type=radio][name=group1]:checked").val();
		var sel2 = $("input[type=radio][name=group2]:checked").val();
		var parent = document.getElementById("bus_list");
		parent.innerHTML = "";
		limit = limit-15;
		show(1);
	}
	function clearBusTable()
	{
		var table=document.getElementById("bus_table");
		var rowCount=table.rows.length;
		for(var i=rowCount-1;i>0;i--){
			table.deleteRow(i);
		}
		mdui.updateTables("#bus_table");
	}


	function updateTable(json){
		list=json.list;
		limit = limit + 15;
		len = list.length;
		var table = document.getElementById('bus_list');
		table.innerHTML="";
		for(var i = 0; i < list.length; i++){
			var newNode = document.createElement("tr");
			var id = list[i].orderid;
			newNode.innerHTML = "<td>"+list[i].orderid+"</td>"
			newNode.innerHTML += "<td>"+list[i].userid +"</td><td>"+list[i].username +"</td><td>"+list[i].stockid +"</td><td>"+list[i].stockname +"</td><td>"+list[i].quantity +"</td><td>"+list[i].bunitprice +"</td><td>" +list[i].createat + "</td>";
			newNode.innerHTML += "<td><button class=\"mdui-btn mdui-btn-raised\" onclick='delet("+id+")'>删除</button><button class=\"mdui-btn mdui-btn-raised\" onclick='modify_record("+i+")'>修改</button></td>"
			table.appendChild(newNode);
		}
	}


	function order(){
		$("input[type=radio]").change(function(){
			var parent = document.getElementById("bus_list");
			parent.innerHTML = "";
			limit = limit-15;

			show(1);
		});
	}
	function show(Order){

		var url = "busquerylistAction";
		url=getQueryPath(url);
		sel1 = $("input[type=radio][name=group1]:checked").val();
		sel2 = $("input[type=radio][name=group2]:checked").val();
		var data1 = '{"Sel1":"'+sel1+'","Sel2":"'+sel2+'","limit":"'+limit+'","length":"'+len+'","OrderId":"'+orderid+'","UserId":"'+userid+'","UserName":"'+username+'","StockId":"'+stockid+'","StockName":"'+stockname+'"}';

		var j = JSON.parse(data1);
		$.post(url,j,function(json){
			//console.log(JSON.stringify(json));
			bus_info=json.list;
			if(json.status == "error"){
				mdui.alert("您不是管理员！");
			}
			else{
				if(json.end == 1 && Order == 0)
					mdui.snackbar("已经到达最后了!");
				else{
					updateTable(json);
				}
			}
		})
		statistics();
	}



	function  drawChart(json){
		console.log('开始绘图');
		var chart=am4core.create("chartdiv",am4charts.XYChart);
		chart.dateFormatter.inputDateFormat="yyyy-MM-dd";
		chart.data=json.data;
		var dateAxis=chart.xAxes.push(new am4charts.DateAxis());
		var valueAxix=chart.yAxes.push(new am4charts.ValueAxis());
		var lineSeries=chart.series.push(new am4charts.LineSeries());
		lineSeries.tooltipText = "{value}"
		lineSeries.dataFields.valueY="value";
		lineSeries.dataFields.dateX="date";
		lineSeries.tooltip.background.cornerRadius = 20;
		lineSeries.tooltip.background.strokeOpacity = 0;
		lineSeries.tooltip.pointerOrientation = "vertical";
		lineSeries.tooltip.label.minWidth = 40;
		lineSeries.tooltip.label.minHeight = 40;
		lineSeries.tooltip.label.textAlign = "middle";
		lineSeries.tooltip.label.textValign = "middle";

		var bullet = lineSeries.bullets.push(new am4charts.CircleBullet());
		bullet.circle.strokeWidth = 2;
		bullet.circle.radius = 4;
		bullet.circle.fill = am4core.color("#fff");
		var bullethover = bullet.states.create("hover");
		bullethover.properties.scale = 1.3;
		chart.cursor = new am4charts.XYCursor();
		chart.cursor.behavior = "panXY";
		chart.cursor.xAxis = dateAxis;
		chart.cursor.snapToSeries = lineSeries;
		lineSeries.name="Sales";
	}

	function statistics(){
		var url = "busstatisticAction";
		url=getQueryPath(url);
		$.post(url,function(json){
			console.log(JSON.stringify(json));
			drawChart(json);
		})
	}
	$('#inc_appbar').load("index_beta.html #appbar");
	$('#inc_menu').load("index_beta.html #left-drawer",function(responseTxt,statusTxt,xhr){
		initPage();
		connect();
		$('#title').text("交易");
	});
	$('#inc_notification').load("index_beta.html #notifications");
	mdui.JQ('#export_dialog').on('click',function(){
		mdui.dialog({
			title: '交易记录导出',
			content: '确定导出到本地吗？',
			buttons: [
				{
					text: '取消'
				},
				{
					text: '确认',
					onClick: function(inst){
						window.location.href='';
						window.location.href='busdataToCSV';
						mdui.alert("已导出到本地！");
					}
				}
			]
		});
	})
</script>