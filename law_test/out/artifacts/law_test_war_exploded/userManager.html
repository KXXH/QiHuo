
<!DOCTYPE html>

<html lang="en">

<head>
    <title>用户管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/mdui/0.4.2/css/mdui.min.css">
    <script src="//cdnjs.loli.net/ajax/libs/mdui/0.4.2/js/mdui.min.js"></script>
    <script src="js/index_beta.js"></script>
    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="https://www.amcharts.com/lib/4/core.js"></script>
    <script src="https://www.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/material.js"></script>
    <script src="https://www.amcharts.com/lib/4/lang/de_DE.js"></script>
    <script src="https://www.amcharts.com/lib/4/geodata/germanyLow.js"></script>
</head>

<body onload="initPage();fetchUserInfo()" class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-pink ">



<div class="mdui-appbar mdui-appbar-fixed">
    <div class="mdui-toolbar mdui-color-theme">
        <a class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#left-drawer'}"><i class="mdui-icon material-icons">menu</i></a>
        <a href="javascript:;" class="mdui-typo-headline">期货交易系统</a>
        <a href="javascript:;" class="mdui-typo-title">用户管理</a>
        <div class="mdui-toolbar-spacer"></div>
        <a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>
        <a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">refresh</i></a>
        <a onclick="logOut();" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">exit_to_app</i></a>
    </div>
</div>

<div class="mdui-drawer mdui-shadow-5" id="left-drawer">
    <div class="mdui-spinner mdui-spinner-colorful" id="loader" style="display: block;margin-left:auto;margin-right:auto;margin-top: 50%"></div>
    <div class="mdui-list mdui-collapse" mdui-collapse="{accordion:true}" id="drawer"></div>

</div>
<div class="mdui-container">
    <ul class="mdui-menu mdui-menu-cascade" id="sort_menu">
        <li class="mdui-menu-item">
            <a class="mdui-ripple">
                首要关键字
                <span class="mdui-menu-item-more"></span>
            </a>
            <ul class="mdui-menu">
                <li class="mdui-menu-item ">
                    <label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="sorted_by" value="UserId" checked/><i class="mdui-radio-icon"></i>ID</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="sorted_by" value="UserName"/><i class="mdui-radio-icon"></i>用户名</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="sorted_by" value="Email"/><i class="mdui-radio-icon"></i>邮箱</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="sorted_by" value="Phone"/><i class="mdui-radio-icon"></i>电话</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-2 mdui-m-r-1"><input type="radio" name="sorted_by" value="CreateAt"/><i class="mdui-radio-icon"></i>创建日期</label>
                </li>
            </ul>
        </li>
        <li class="mdui-menu-item">
            <a class="mdui-ripple">
                次要关键字
                <span class="mdui-menu-item-more"></span>
            </a>
            <ul class="mdui-menu">
                <li class="mdui-menu-item ">
                    <label class="mdui-radio mdui-m-l-1 mdui-m-r-1"><input type="radio" name="sorted_by2" value="UserId" checked/><i class="mdui-radio-icon"></i>ID</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-1 mdui-m-r-1"><input type="radio" name="sorted_by2" value="UserName"/><i class="mdui-radio-icon"></i>用户名</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-1 mdui-m-r-1"><input type="radio" name="sorted_by2" value="Email"/><i class="mdui-radio-icon"></i>邮箱</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-1 mdui-m-r-1"><input type="radio" name="sorted_by2" value="Phone"/><i class="mdui-radio-icon"></i>电话</label>
                </li>
                <li class="mdui-menu-item">
                    <label class="mdui-radio mdui-m-l-1 mdui-m-r-1"><input type="radio" name="sorted_by2" value="CreateAt"/><i class="mdui-radio-icon"></i>创建日期</label>
                </li>
            </ul>
        </li>
    </ul>
    <button class="mdui-btn" onclick="addUser()">添加</button>
    <button class="mdui-btn" mdui-menu="{target:'#sort_menu'}">
        排序
    </button>
    <button class="mdui-btn" mdui-dialog="{'target':'#search_dialog'}">查找</button>
    <a class="mdui-btn" href="user_print.htm">打印</a>
    <a class="mdui-btn" id="output">导出</a>
    <div class="mdui-dialog" id="search_dialog">
        <div class="mdui-dialog-title">查找用户</div>
        <form name="user_search_form" class="mdui-dialog-content">
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">用户名</label>
                <input class="mdui-textfield-input" id="username_search" name="username_search"/>
            </div>
        </form>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn" onclick="searchUser()" mdui-dialog-confirm>
                搜索
            </button>
        </div>
    </div>


    <div class="mdui-dialog" id="edit_dialog">
        <div class="mdui-dialog-title">编辑用户</div>
        <form name="user_edit_form" class="mdui-dialog-content">
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">ID</label>
                <input class="mdui-textfield-input" disabled type="number" id="user_id_edit" name="user_id"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">用户名</label>
                <input class="mdui-textfield-input" type="text" id="username_edit" name="username"/>
            </div>
            <div class="mdui-textfield" id="password_box" style="display:none">
                <label class="mdui-textfield-label">密码</label>
                <input class="mdui-textfield-input" type="password" id="password_edit" name="password"/>
            </div>
            <div class="mdui-textfiel">
                <label class="mdui-textfield-label">邮箱</label>
                <input class="mdui-textfield-input" type="email" id="email_edit" name="email"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">电话</label>
                <input class="mdui-textfield-input" type="number" id="phone_edit" name="phone"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">微信</label>
                <input class="mdui-textfield-input" type="text" id="wechat_id_edit" name="wechat_id"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">角色</label>
                <input class="mdui-textfield-input" type="text" id="role_id_edit" name="role_id"/>
            </div>
            <div class="mdui-dialog-actions" id="submit_btn">
                <button class="mdui-btn" onclick="submitEdit()">提交</button>
            </div>
        </form>
    </div>
    <div class="mdui-table-fluid">
        <table class="mdui-table mdui-table-hoverable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>电话</th>
                    <th>微信</th>
                    <th>注册日期</th>
                    <th>角色</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="user_list">

            </tbody>
        </table>
    </div>
    <div class="mdui-typo">
        <h1>用户新增注册统计</h1>
        <div class="mdui-img-fluid" id="chartdiv" onload="createChart()">

        </div>
    </div>

</div>
</body>
<script>


    var user_info;
    var edit_dialog=new mdui.Dialog("#edit_dialog");
    var search_dialog=new mdui.Dialog("#search_dialog");
    edit_dialog.close();
    $('input[type=radio][name=sorted_by]').change(function(){
        fetchUserInfo();
    });
    $('input[type=radio][name=sorted_by2]').change(function(){
        fetchUserInfo();
    });
    document.getElementById("output").href="/dataToCSVAction?token="+getCookie("tocken");

    function addUser(){
        console.log("add method is on");
        document.forms['user_edit_form']['user_id'].value="";
        document.forms['user_edit_form']['username'].value="";
        document.forms['user_edit_form']['email'].value="";
        document.forms['user_edit_form']['phone'].value="";
        document.forms['user_edit_form']['wechat_id'].value="";
        document.forms['user_edit_form']['role_id'].value="";
        document.getElementById("password_box").style.display="block";
        document.getElementById("submit_btn").innerHTML='<button class="mdui-btn" id="submit_btn" onclick="addUserInfo()">提交</button>'
        edit_dialog.open();
    }
    function submitEdit(){
        if(document.forms['user_edit_form']['user_id'].value.length==0){addUserInfo();}
        else{updateUserInfo();}
    }
    function addUserInfo(){
        var username=document.forms['user_edit_form']['username'].value;
        var email=document.forms['user_edit_form']['email'].value;
        var phone=document.forms['user_edit_form']['phone'].value;
        var wechat_id=document.forms['user_edit_form']['wechat_id'].value;
        var role_id=document.forms['user_edit_form']['role_id'].value;
        var password=document.forms['user_edit_form']['password'].value;
        var token=getCookie("tocken");
        var j={'username':username,'email':email,'phone':phone,'wechat_id':wechat_id,'role_id':role_id,'token':token,'password':password};
        var url='/userAddAction';
        $.post(url,j,function(json){
            if(json.status=="ok"){
                mdui.snackbar({'message':'添加成功!'});
            }
            else{
                mdui.snackbar({'message':'添加失败!'});
            }
            edit_dialog.close();
        })
    }
    function  drawChart(json){
        console.log('开始绘图');
        var chart=am4core.create("chartdiv",am4charts.XYChart);
        chart.dateFormatter.inputDateFormat="yyyy-MM-dd";
        chart.data=json.data;
        var dateAxis=chart.xAxes.push(new am4charts.DateAxis());
        var valueAxix=chart.yAxes.push(new am4charts.ValueAxis());
        var lineSeries=chart.series.push(new am4charts.LineSeries());
        lineSeries.tooltipText = "{value}"
        lineSeries.dataFields.valueY="value";
        lineSeries.dataFields.dateX="date";
        lineSeries.tooltip.background.cornerRadius = 20;
        lineSeries.tooltip.background.strokeOpacity = 0;
        lineSeries.tooltip.pointerOrientation = "vertical";
        lineSeries.tooltip.label.minWidth = 40;
        lineSeries.tooltip.label.minHeight = 40;
        lineSeries.tooltip.label.textAlign = "middle";
        lineSeries.tooltip.label.textValign = "middle";

        var bullet = lineSeries.bullets.push(new am4charts.CircleBullet());
        bullet.circle.strokeWidth = 2;
        bullet.circle.radius = 4;
        bullet.circle.fill = am4core.color("#fff");
        var bullethover = bullet.states.create("hover");
        bullethover.properties.scale = 1.3;
        chart.cursor = new am4charts.XYCursor();
        chart.cursor.behavior = "panXY";
        chart.cursor.xAxis = dateAxis;
        chart.cursor.snapToSeries = lineSeries;
        lineSeries.name="Sales";
    }

    function createChart(){

        var token=getCookie("tocken");
        var j={'token':token};
        var url='/userStatisticAction';
        $.post(url,j,function(json){
            console.log(JSON.stringify(json));
            drawChart(json);
        });

    }

    function searchUser(){
        var sort=$('input[type=radio][name=sorted_by]:checked').val();
        var sort2=$('input[type=radio][name=sorted_by2]:checked').val();
        var username=document.forms['user_search_form']['username_search'].value;
        var token=getCookie('tocken');
        var url='/userQueryAction';
        var j={'token':token,'username':username,'sorted_by':sort,'sorted_by2':sort2};
        $.post(url,j,function(json){
            user_info=json.list;
            updateTable(json);
            search_dialog.close();
        })
    }

    function updateUserInfo(){
        var user_id=document.forms['user_edit_form']['user_id'].value;
        var username=document.forms['user_edit_form']['username'].value;
        var email=document.forms['user_edit_form']['email'].value;
        var phone=document.forms['user_edit_form']['phone'].value;
        var wechat_id=document.forms['user_edit_form']['wechat_id'].value;
        var role_id=document.forms['user_edit_form']['role_id'].value;
        var token=getCookie("tocken");
        var j={'user_id':user_id,'username':username,'email':email,'phone':phone,'wechat_id':wechat_id,'role_id':role_id,'token':token};
        var url='/userEditAction';
        $.post(url,j,function(json){
            if(json.status=="ok"){
                mdui.snackbar({'message':'修改成功!'});
            }
            else{
                mdui.snackbar({'message':'修改失败!'});
            }

        })
    }

    function delUserInfo(i){
        if(!confirm("你确定要删除这个用户吗?")){
            return;
        }
        var user_id=user_info[i].user_id;
        console.log(user_id);
        var j={'user_id':user_id,'token':getCookie('tocken')};
        console.log(JSON.stringify(j));
        var url='userDeleteAction';
        $.post(url,j,function(json){
            if(json.status=="ok"){
                mdui.snackbar({'message':'删除成功!'});
                fetchUserInfo();
            }
            else{
                mdui.snackbar({'message':'删除失败!'});
            }
        })
    }

    function editUser(i){
        document.forms['user_edit_form']['user_id'].value=user_info[i].user_id;
        document.forms['user_edit_form']['username'].value=user_info[i].username;
        document.forms['user_edit_form']['email'].value=user_info[i].email;
        document.forms['user_edit_form']['phone'].value=user_info[i].phone;
        document.forms['user_edit_form']['wechat_id'].value=user_info[i].wechat_id;
        document.forms['user_edit_form']['role_id'].value=user_info[i].role_id;
        document.getElementById("password_box").style.display="none";
        edit_dialog.open();
    }

    function fetchUserInfo(){
        var sort=$('input[type=radio][name=sorted_by]:checked').val();
        var sort2=$('input[type=radio][name=sorted_by2]:checked').val();
        console.log(sort2);
        var t={'token':getCookie("tocken"),'sorted_by':sort,'sorted_by2':sort2};
        var url="/userQueryAction";
        $.post(url,t,function(json){
            console.log("收到JSON");
            console.log(JSON.stringify(json));
            user_info=json.list;
            updateTable(json);

        });
        createChart();
    }

    function updateTable(json){
        user_info=json.list;
        var table = document.getElementById('user_list');
        table.innerHTML="";
        for(var i=0;i<json.list.length;i++){
            var row = document.createElement('tr');
            var userId = document.createElement('td');
            userId.innerText=json.list[i].user_id;
            row.appendChild(userId);
            var username = document.createElement('td');
            username.innerText=json.list[i].username;
            row.appendChild(username);
            var email = document.createElement('td');
            email.innerText=json.list[i].email;
            row.appendChild(email);
            var phone = document.createElement('td');
            phone.innerText=json.list[i].phone;
            row.appendChild(phone);
            var wechat_id = document.createElement('td');
            wechat_id.innerText=json.list[i].wechat_id;
            row.appendChild(wechat_id);
            var create_at = document.createElement('td');
            create_at.innerText=json.list[i].create_at;
            row.appendChild(create_at);
            var role_id = document.createElement('td');
            role_id.innerText=json.list[i].role_id;
            row.appendChild(role_id);
            var buttonBox = document.createElement('td');
            var button = document.createElement('button');
            button.className="mdui-btn mdui-color-theme-accent"
            button.setAttribute("mdui-menu","{target:'#userMenu"+i+"',position:'bottom',fixed:true}");
            button.innerText="编辑";


            var menu = document.createElement('ul');
            menu.id="userMenu"+i;
            menu.className="mdui-menu";
            var item = document.createElement('li');
            item.className="mdui-menu-item";
            item.onclick="deleteUser("+i+")";
            item.innerHTML="<a onclick='delUserInfo("+i+")'>删除</a>";
            menu.appendChild(item);
            var item = document.createElement('li');
            item.className="mdui-menu-item";
            item.innerHTML="<a onclick='editUser("+i+")'>修改</a>";
            menu.appendChild(item);
            buttonBox.appendChild(button);
            buttonBox.appendChild(menu);
            row.appendChild(buttonBox);
            table.appendChild(row);
        }
        mdui.updateTables("#user_list")
    }


</script>
</html>